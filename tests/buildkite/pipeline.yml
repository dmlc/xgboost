env:
  DOCKER_CACHE_ECR_ID: "492475357299"
  DOCKER_CACHE_ECR_REGION: "us-west-2"
steps:
  - label: ":moneybag: Enforce daily budget"
    command: "tests/buildkite/enforce_daily_budget.sh"
    key: enforce-daily-budget
    agents:
      queue: pipeline-loader
  - wait
  - block: ":rocket: Run this test job"
    if: build.pull_request.id != null || build.branch =~ /^dependabot\//
  #### -------- CONTAINER BUILD --------
  - label: ":docker: Build containers"
    commands:
      - "tests/buildkite/build-containers.sh cpu"
      - "tests/buildkite/build-containers.sh gpu"
      - "tests/buildkite/build-containers.sh gpu_build_rockylinux8"
    key: build-containers
    agents:
      queue: linux-amd64-cpu
  - wait
  #### -------- BUILD --------
  - label: ":console: Build JVM packages"
    timeout_in_minutes: 30
    command: "tests/buildkite/build-jvm-packages.sh"
    key: build-jvm-packages
    agents:
      queue: linux-amd64-cpu
  - label: ":console: Build JVM package doc"
    command: "tests/buildkite/build-jvm-doc.sh"
    key: build-jvm-doc
    agents:
      queue: linux-amd64-cpu
  - wait
  #### -------- TEST --------
  - label: ":console: Run integration tests with JVM packages"
    command: "tests/buildkite/test-integration-jvm-packages.sh"
    key: test-integration-jvm-packages
    agents:
      queue: linux-amd64-cpu
  - wait
  #### -------- DEPLOY JVM --------
  - label: ":console: Deploy JVM packages"
    command: "tests/buildkite/deploy-jvm-packages.sh"
    key: deploy-jvm-packages
    agents:
      queue: linux-amd64-cpu
