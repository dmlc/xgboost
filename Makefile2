SHELL := /bin/bash

NCCL := $(shell bash get_cuda.sh)

# https://xgboost.readthedocs.io/en/latest/build.html
default: libxgboost
libxgboost: libxgboostgpu libxgboostp2nccl libxgboostp3
libxgboost2: libxgboostgpu libxgboostp2nonccl libxgboostp3
libxgboost-cpu: libxgboostcpu libxgboostp2cpu-only libxgboostp3

libxgboostgpu:
	git submodule init && git submodule update dmlc-core && git submodule update && git submodule update cub && git submodule update gputreeshap
libxgboostcpu:
	git submodule init && git submodule update dmlc-core && git submodule update gputreeshap

libxgboostp2nccl:
	#pip install -r requirements_runtime.txt
	# pip install -r requirements_build.txt
	echo "arch: `arch`"
	echo "cuda_short: `cat cuda_short.txt`"
	mkdir -p build && cd build && cmake .. -DUSE_CUDA=ON ${NCCL} -DCMAKE_BUILD_TYPE=RELWITHDEBINFO && make -j`nproc`

libxgboostp2nonccl:
	#pip install -r requirements_runtime.txt
	# pip install -r requirements_build.txt
	mkdir -p build && cd build && cmake .. -DUSE_CUDA=ON -DCMAKE_BUILD_TYPE=RELWITHDEBINFO && make -j`nproc`

libxgboostp2cpu-only:
	#pip install -r requirements_runtime.txt
	# pip install -r requirements_build.txt
	mkdir -p build && cd build && cmake .. -DUSE_CUDA=OFF -DCMAKE_BUILD_TYPE=RELWITHDEBINFO && make -j`nproc`

libxgboostp3:
	cd python-package && rm -rf dist && python setup.py bdist_wheel


.PHONY: build/VERSION.txt

build/VERSION.txt:
	@mkdir -p build
	cd python-package; python setup.py --version > ../build/VERSION.txt 2>/dev/null
